<!DOCTYPE html>

<html>

<head lang="zh-cn">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico">
    <title>办公会系统</title>
    <link rel="stylesheet" href="./bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <script src="./js/md5.js"></script>
    <script src="./js/jquery-1.12.4.min.js"> </script>
    <script src="./bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <style>
        body {
            padding-top: 50px;
        }

        .starter {
            padding: 10px 15px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- 导航 -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- <div class="container-fluid"> -->
            <div class="navbar-header">
                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse"
                    data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/index.html">办公会系统</a>
            </div>

            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav" id="my_tab">
                    <!-- <li class="hide"><a href="#">主页</a></li> -->
                    <!-- <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">财务信息<span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="">上月经费开支</a></li>
                            <li><a href="">下月大项开支</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">油料信息<span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="">油料统计</a></li>
                            <li><a href="">油料计划</a></li>
                        </ul>
                    </li>
                    <li><a href="#">车辆维修</a></li>
                    <li><a href="#">数据汇总</a></li>
                    <li><a href="#">系统管理</a></li> -->
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li id="login" class="hidden-sm"><a href="#">登录</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span
                                class="glyphicon glyphicon-align-justify"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <!-- <li><a href="#">权限申请</a> </li> -->
                            <li id="change_ps" hidden><a href="#">修改密码</a> </li>
                            <li id="logout"><a href="#">退　　出</a> </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 内容 -->
    <div class="container">
        <div class="starter">
            <div class="tab-content">
                <div class="tab-pane active" id="welcome">
                    <h1>欢迎来到办公会数据统计系统</h1>
                    <p class="lead">这里是CFJFQ保障处建立的用于统计和形成办公会材料的网站，它将一步步完成并投入运营</p>
                </div>
                <div class="tab-pane" id="main">
                    <p>主页</p>
                </div>
                <div class="tab-pane" id="jfkz">
                    <p>上月经费开支</p>
                </div>
                <div class="tab-pane" id="dxkz">
                    <p>下月大项开支计划</p>
                </div>
                <div class="tab-pane" id="yltj">
                    <p>本月油料统计</p>
                </div>
                <div class="tab-pane" id="yljh">
                    <p>下月油料计划</p>
                </div>
                <div class="tab-pane" id="clwx">
                    <p>车辆维修</p>
                </div>
                <div class="tab-pane" id="bgh_sjhz">
                    <p>办公会数据汇总</p>
                </div>
                <div class="tab-pane" id="admin">
                    <p>系统管理</p>
                </div>
            </div>
        </div>
    </div>

    <!--change_ps_box Modal -->
    <div class="modal fade" id="change_ps_box" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="CPModalLabel">更改密码</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="now_password" class="control-label">现有密码:</label>
                            <input type="password" class="form-control" id="now_password" autocomplete="off">
                        </div>
                        <div class="alert alert-danger" role="alert" hidden>密码不正确</div>
                        <div class="form-group">
                            <label for="new_password" class="control-label">新的密码:</label>
                            <input type="password" class="form-control" id="new_password" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="re_new_password" class="control-label">重复密码:</label>
                            <input type="password" class="form-control" id="re_new_password" autocomplete="off">
                        </div>
                        <div class="alert alert-danger" role="alert" hidden>密码不一致</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" disabled>更改密码</button>
                </div>
            </div>
        </div>
    </div>
    <!--login_box Modal -->
    <div class="modal fade" id="login_box" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="LoginModalLabel">登录</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="username" class="control-label">用户名:</label>
                            <input type="text" class="form-control" id="username">
                        </div>
                        <div class="form-group">
                            <label for="password" class="control-label">密码:</label>
                            <input type="password" class="form-control" id="password" autocomplete="off">
                        </div>
                        <div class="alert alert-danger" role="alert" hidden>密码错误</div>
                        <div class="checkbox left">
                            <label>
                                <input type="checkbox" value="remember">
                                一周内自动登录
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary">登录</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 脚本分割线 -------------------------------------------------------------------------------------------->
    <script>
        var user = null;

        // 构建页面结构
        function make_banner(user) {
            $("#my_tab").empty()
            if (user == null || user['power'] == 0) {
                console.log()
                $("#my_tab").append("<li class=\"hide\"><a href=\"#welcome\" data-toggle = \"tab\">欢迎</a></li>")
                $("#my_tab a:last").tab('show')
                return
            }
            $.getJSON(
                'data/power.json',
                function (result) {
                    $.each(result, function (i, field) {
                        var li_html = null
                        if (field["children"] == null && (field["power"] & user["power"]) > 0) {
                            li_html = "<li><a href = \"#" + i + "\" data-toggle = \"tab\">" + field[
                                "xm_name"] + "</a></li>"
                        } else if ((field["power"] & user["power"]) > 0) {
                            li_html =
                                "<li class=\"dropdown\"><a class=\"dropdown-toggle\" data-toggle=\"dropdown\" href=>" +
                                field["xm_name"] +
                                "<span class=\"caret\"></span></a><ul class=\"dropdown-menu\" role=\"menu\">"
                            var children_li = field["children"]
                            $.each(children_li, function (j, children_li_a) {
                                if ((children_li_a["power"] & user["power"]) > 0) {
                                    li_html += "<li><a href = \"#" + j +
                                        "\" data-toggle = \"tab\">" + children_li_a["xm_name"] +
                                        "</a></li>"
                                }
                            })
                            li_html += "</ul>"
                        }
                        $("#my_tab").append(li_html)
                        $('#my_tab a:first').tab('show') 
                        $('#my_tab a').click(function (e) {
                            e.preventDefault()
                            $(this).tab('show')
                        })
                    })
                })
        }

        // 让标题头可以点击
        $('#my_tab a').click(function (e) {
            e.preventDefault()
            $(this).tab('show')
        })
        // 检查是否登录
        $(document).ready(function () {
            $.ajax({
                'type': 'GET',
                'url': 'src/login.php',
                'data': {
                    'action': 'is_login'
                },
                'success': function (data) {
                    request = JSON.parse(data)
                    if (request['states'] == 5) {
                        user = JSON.parse(request['data'])
                        $('#login a').text(user['username'])
                        $('#change_ps').show()
                    }
                    make_banner(user)
                }
            })
        })
        // 恢复box中的设置
        $('#username, #password').change(function () {
            $(this).removeClass('alert-danger')
            $(('.alert.alert-danger')).hide()
        })
        // 显示login登录框
        $('#login').click(function () {
            if ($(this).text() == '登录') {
                $('#username').val('').removeClass('alert-danger')
                $('password').val('').removeClass('alert-danger')
                $('#login_box .alert').hide()
                $('#login_box').modal('show')
            }
        })
        // 点击登录
        $('#login_box button').last().click(function () {
            $.ajax({
                'url': 'src/login.php',
                'type': 'POST',
                'data': {
                    'action': 'login',
                    'username': $('#username').val(),
                    'password': hex_md5($('#password').val()),
                    'remember': $(':checkbox:checked').val() ? "remember" : "n"
                },
                'success': function (data) {
                    request = JSON.parse(data)
                    switch (request['states']) {
                        case 4:
                            $('#username').addClass('alert-danger').val('')
                            $('#password').val('')
                            $('#login_box .alert').show().text("没有这个用户")
                            break
                        case 3:
                            $('#username').addClass('alert-danger').val('')
                            $('#password').val('')
                            $('#login_box .alert').show().text("用户被锁定，请联系管理员: 18304900713")
                            break
                        case 2:
                            $('#password').addClass('alert-danger').val('')
                            $('#username').val('')
                            $('#login_box .alert').show().text("密码不正确，连续三次错误用户将被锁定")
                            break
                        case 1:
                            user = JSON.parse(request['data'])
                            $('#login a').text(user['username'])
                            $('#change_ps').show()
                            make_banner(user)
                            $('#login_box').modal('hide')
                    }
                }
            })
        })
        // 显示修改密码框
        $('#change_ps').click(function () {
            $('#now_password').val('').removeClass('alert-danger')
            $('#new_password').val('').removeClass('alert-danger')
            $('#re_new_password').val('').removeClass('alert-danger')
            $('#change_ps_box .alert').hide()
            $('#change_ps_box button').disabled = true
            $('#change_ps_box').modal('show')
        })
        // 检查重复密码是否正确
        $('#now_password, #re_new_password, #new_password').change(function () {
            if (hex_md5($('#now_password').val()) != user['password']) {
                $('#now_password').addClass("alert-danger")
                $('#change_ps_box .alert').first().show()
                return
            }
            $('#now_password').removeClass("alert-danger")
            $('#change_ps_box .alert').first().hide()
            if ($("#new_password").val() != $('#re_new_password').val()) {
                $('#re_new_password').addClass("alert-danger")
                $('#change_ps_box .alert').last().show().text("密码不一致")
                return
            }
            $('#re_new_password').removeClass("alert-danger")
            $('#change_ps_box .alert').last().hide()
            if ($("#new_password").val() == "") {
                $('#new_password').addClass("alert-danger")
                $('#change_ps_box .alert').last().show().text("密码不能为空")
                return
            }
            $('#new_password').removeClass("alert-danger")
            $('#change_ps_box .alert').last().hide()

            $('#change_ps_box button').last().removeAttr("disabled")
        })
        // 点击修改密码
        $("#change_ps_box button").last().click(function () {
            $.ajax({
                'url': 'src/login.php',
                'type': 'POST',
                'data': {
                    'action': 'change_ps',
                    'username': user['username'],
                    'now_password': user['password'],
                    'new_password': hex_md5($('#new_password').val()),
                },
                'success': function (data) {
                    request = JSON.parse(data)
                    user = JSON.parse(request['data'])
                    alert('密码修改成功')
                    $('#change_ps_box').modal('hide')
                }
            })
        })
        // logout退出
        $("#logout").click(function () {
            $.ajax({
                'type': 'GET',
                'url': 'src/login.php',
                'data': {
                    'action': 'logout'
                },
                'success': function (data) {
                    user = null
                    make_banner(user)
                    $('#login a').text('登录')
                    $('#change_ps').hide()
                    alert('退出成功')
                }
            })
        })
    </script>
</body>

</html>